# Claude Code Instructions for Mycelium Project

> **SCOPE**: You are ONLY working on the **Dashboard & App** portion of this project.
> Everything before the Dashboard (landing, auth, onboarding, quiz) is **FROZEN** and must NOT be modified.

---

## üö® Critical Rules

1. **NEVER** edit auto-generated files (listed below)
2. **NEVER** touch pre-dashboard flow files
3. **NEVER** create new Supabase clients or migration files
4. When you need database changes, edge function deployments, or secrets ‚Üí add a `<!-- LOVABLE-ACTION -->` marker
5. Always use existing import patterns

---

## üìÅ File Boundaries

### üö´ NEVER TOUCH - Auto-Generated (Lovable Cloud Managed)

| File | Reason |
|------|--------|
| `.env` | Environment variables - auto-managed |
| `src/integrations/supabase/client.ts` | Supabase client - auto-generated |
| `src/integrations/supabase/types.ts` | TypeScript types - auto-generated |
| `supabase/config.toml` | Supabase config - auto-generated |
| `supabase/migrations/*` | Database migrations - Lovable only |
| `package.json` | Dependencies - use Lovable to add packages |
| `bun.lockb`, `package-lock.json` | Lock files |

### üö´ NEVER TOUCH - Pre-Dashboard Flow (FROZEN)

| File/Folder | Description |
|-------------|-------------|
| `src/pages/Index.tsx` | Landing page |
| `src/pages/Auth.tsx` | Authentication page |
| `src/pages/Onboarding.tsx` | Onboarding flow |
| `src/pages/Quiz.tsx` | Quiz page |
| `src/pages/Quiz2.tsx` | Quiz variant |
| `src/components/landing/*` | All landing components (15+ files) |
| `src/components/onboarding/*` | Onboarding components |
| `src/components/quiz/*` | Quiz components |
| `src/hooks/useLandingChat.ts` | Landing-specific hook |

### ‚úÖ SAFE TO EDIT - Dashboard & App

#### Pages
| File | Description |
|------|-------------|
| `src/pages/Dashboard.tsx` | Main dashboard - deck list |
| `src/pages/DeckBuilder.tsx` | Deck building experience |
| `src/pages/Marketplace.tsx` | Card marketplace |
| `src/pages/Settings.tsx` | User settings |
| `src/pages/CheckoutSuccess.tsx` | Payment success page |
| `src/pages/AdminEmails.tsx` | Admin email panel |
| `src/pages/NotFound.tsx` | 404 page |

#### Components - Dashboard
| Folder | Files |
|--------|-------|
| `src/components/dashboard/*` | `WelcomeBackOverlay.tsx` |
| `src/components/CreateDeckDialog.tsx` | Deck creation modal |
| `src/components/DeckCard.tsx` | Deck card display |
| `src/components/NavLink.tsx` | Navigation link |
| `src/components/ErrorBoundary.tsx` | Error handling |

#### Components - Deck Builder (35+ files)
| Folder | Description |
|--------|-------------|
| `src/components/deck-builder/*.tsx` | All deck builder components |
| `src/components/deck-builder/chat/*` | Chat components |
| `src/components/deck-builder/crafting/*` | Card crafting wizard |
| `src/components/deck-builder/health/*` | Deck health dashboard |
| `src/components/deck-builder/research/*` | Research phase components |
| `src/components/deck-builder/review/*` | Review & collaboration |

#### Components - Marketplace
| Folder | Description |
|--------|-------------|
| `src/components/marketplace/*` | All marketplace components (12 files) |

#### Components - Paywall & Admin
| Folder | Description |
|--------|-------------|
| `src/components/paywall/*` | Subscription/paywall UI |
| `src/components/admin/*` | Admin panel components |

#### Hooks (App-Specific)
| File | Description |
|------|-------------|
| `src/hooks/useDeckCards.ts` | Deck cards management |
| `src/hooks/useDeckHealth.ts` | Deck health analysis |
| `src/hooks/useGroupChat.ts` | Group chat functionality |
| `src/hooks/useRecommendations.ts` | Card recommendations |
| `src/hooks/useResearch.ts` | Research phase |
| `src/hooks/useSubscription.ts` | Subscription status |
| `src/hooks/useTeamChat.ts` | Team chat |
| `src/hooks/useUserDecks.ts` | User decks list |

### ‚ö†Ô∏è CAUTION ZONE - Shared Components (Ask Before Major Changes)

These are used by BOTH landing AND app - small edits OK, structural changes need care:

| File/Folder | Risk Level |
|-------------|------------|
| `src/components/ui/*` | üü° Shared UI primitives - small styling OK |
| `src/data/translations.ts` | üü° Has both landing + app strings |
| `src/data/teamCharacters.ts` | üü° Used in landing previews too |
| `src/contexts/LanguageContext.tsx` | üü° Shared context |
| `src/hooks/useTranslation.ts` | üü° Shared utility |
| `src/hooks/use-mobile.tsx` | üü° Shared utility |
| `src/hooks/use-toast.ts` | üü° Shared utility |
| `src/lib/utils.ts` | üü° Shared utilities |
| `src/index.css` | üü° Global styles - add, don't remove |
| `tailwind.config.ts` | üü° Design tokens - add, don't remove |

### üìù EDGE FUNCTIONS - Code Editable, Lovable Deploys

You CAN edit the code in these files, but you CANNOT deploy them. Add a marker when done.

| Function | Purpose |
|----------|---------|
| `supabase/functions/analyze-deck-health/index.ts` | AI deck analysis |
| `supabase/functions/evaluate-card/index.ts` | Card evaluation |
| `supabase/functions/generate-card-image/index.ts` | AI image generation |
| `supabase/functions/generate-website-brief/index.ts` | Website brief |
| `supabase/functions/recommend-cards/index.ts` | Card recommendations |
| `supabase/functions/research-discuss/index.ts` | Research discussion |
| `supabase/functions/research-execute/index.ts` | Research execution |
| `supabase/functions/research-orchestrator/index.ts` | Research orchestration |
| `supabase/functions/crystallize-insight/index.ts` | Insight crystallization |
| `supabase/functions/suggest-card-field/index.ts` | Field suggestions |
| `supabase/functions/team-chat/index.ts` | Team chat AI |
| `supabase/functions/team-group-chat/index.ts` | Group chat AI |
| `supabase/functions/create-checkout/index.ts` | Stripe checkout |
| `supabase/functions/customer-portal/index.ts` | Stripe portal |
| `supabase/functions/check-subscription/index.ts` | Subscription check |
| `supabase/functions/stripe-webhook/index.ts` | Stripe webhooks |
| `supabase/functions/broadcast-email/index.ts` | Email broadcast |
| `supabase/functions/send-playbook-email/index.ts` | Playbook emails |
| `supabase/functions/check-email-sequences/index.ts` | Email sequences |
| `supabase/functions/get-broadcast-history/index.ts` | Broadcast history |
| `supabase/functions/get-leads/index.ts` | Leads retrieval |
| `supabase/functions/get-sequence-logs/index.ts` | Sequence logs |

---

## üóÑÔ∏è Database Schema Reference

### Core Tables

#### `decks`
```sql
id: uuid (PK)
user_id: uuid (FK to auth.users)
title: text
description: text?
theme: text?
created_at: timestamptz
updated_at: timestamptz
```

#### `deck_cards`
```sql
id: uuid (PK)
deck_id: uuid (FK to decks)
card_slot: integer
card_type: text
card_data: jsonb
card_image_url: text?
evaluation: jsonb?
last_evaluated_at: timestamptz?
is_insight: boolean
created_at: timestamptz
updated_at: timestamptz
```

#### `profiles`
```sql
id: uuid (PK, FK to auth.users)
username: text?
avatar_url: text?
onboarding_completed: boolean
created_at: timestamptz
updated_at: timestamptz
```

#### `user_subscriptions`
```sql
id: uuid (PK)
user_id: uuid (FK to auth.users)
tier: enum ('free', 'pro', 'ultra')
spore_balance: integer
stripe_customer_id: text?
stripe_subscription_id: text?
started_at: timestamptz?
expires_at: timestamptz?
created_at: timestamptz
updated_at: timestamptz
```

#### `deck_collaborators`
```sql
id: uuid (PK)
deck_id: uuid (FK to decks)
user_id: uuid (FK to profiles)
role: enum ('reviewer', 'editor')
invited_at: timestamptz
```

#### `card_comments`
```sql
id: uuid (PK)
card_id: uuid (FK to deck_cards)
author_id: uuid (FK to profiles)
content: text
field_name: text?
comment_type: enum ('comment', 'suggestion', 'approval')
is_resolved: boolean
created_at: timestamptz
updated_at: timestamptz
```

#### `card_reviews`
```sql
id: uuid (PK)
card_id: uuid (FK to deck_cards)
reviewer_id: uuid (FK to profiles)
status: enum ('pending', 'in_progress', 'completed')
created_at: timestamptz
completed_at: timestamptz?
```

#### `research_sessions`
```sql
id: uuid (PK)
deck_id: uuid (FK to decks, unique)
current_card_slot: integer
status: enum ('locked', 'researching', 'ready', 'accepted')
started_at: timestamptz?
completed_at: timestamptz?
created_at: timestamptz
updated_at: timestamptz
```

#### `research_results`
```sql
id: uuid (PK)
deck_id: uuid (FK to decks)
card_slot: integer
findings: jsonb
sources: jsonb
rarity_scores: jsonb
team_comments: jsonb
verdict: enum ('go', 'conditional_go', 'pivot', 'stop')?
final_rarity: text?
status: enum ('locked', 'researching', 'ready', 'accepted')
researched_at: timestamptz?
accepted_at: timestamptz?
created_at: timestamptz
updated_at: timestamptz
```

#### `marketplace_listings`
```sql
id: uuid (PK)
seller_id: uuid (FK to auth.users)
card_id: uuid (FK to deck_cards)
price_spore: integer
price_usd: numeric?
status: enum ('active', 'sold', 'removed')
created_at: timestamptz
sold_at: timestamptz?
```

#### `marketplace_purchases`
```sql
id: uuid (PK)
listing_id: uuid (FK to marketplace_listings)
buyer_id: uuid
seller_id: uuid
price_spore: integer
platform_fee_spore: integer
seller_earnings_spore: integer
purchased_at: timestamptz
```

#### `spore_transactions`
```sql
id: uuid (PK)
user_id: uuid (FK to auth.users)
amount: integer
transaction_type: enum ('subscription_credit', 'purchase', 'sale', 'bonus', 'refund')
description: text?
reference_id: text?
created_at: timestamptz
```

### Existing Secrets (Already Configured)
- `RESEND_API_KEY`
- `LOVABLE_API_KEY`
- `STRIPE_SECRET_KEY`
- `TAVILY_API_KEY`
- `SUPABASE_URL`, `SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY`, `SUPABASE_DB_URL`

---

## üìê Import Patterns

### ‚úÖ CORRECT Imports

```typescript
// Supabase client - ALWAYS use this
import { supabase } from "@/integrations/supabase/client";

// UI components
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader } from "@/components/ui/card";
import { Dialog, DialogContent, DialogTrigger } from "@/components/ui/dialog";

// Hooks
import { useToast } from "@/hooks/use-toast";
import { useDeckCards } from "@/hooks/useDeckCards";

// Data
import { teamCharacters } from "@/data/teamCharacters";
import { cardDefinitions } from "@/data/cardDefinitions";

// Types from Supabase
import type { Database } from "@/integrations/supabase/types";

// Utils
import { cn } from "@/lib/utils";

// Third-party
import { motion } from "framer-motion";
import { useNavigate, useParams } from "react-router-dom";
```

### ‚ùå NEVER DO

```typescript
// ‚ùå NEVER create new Supabase clients
import { createClient } from "@supabase/supabase-js";

// ‚ùå NEVER use env vars directly for Supabase
const url = import.meta.env.VITE_SUPABASE_URL;

// ‚ùå NEVER import from integrations/supabase other than client and types
import { something } from "@/integrations/supabase/something-else";

// ‚ùå NEVER use direct colors in components
className="text-white bg-purple-500" // Use semantic tokens instead
className="text-foreground bg-primary" // ‚úÖ CORRECT
```

---

## üè∑Ô∏è LOVABLE-ACTION Markers

When you need Lovable to do something, add these markers in your code or in a summary:

### Database Changes
```markdown
<!-- LOVABLE-ACTION: DATABASE -->
Need migration to add column `new_column` (type: text) to table `deck_cards`
<!-- /LOVABLE-ACTION -->

<!-- LOVABLE-ACTION: DATABASE -->
Need new table `feature_flags` with columns: id (uuid), name (text), enabled (boolean), user_id (uuid)
<!-- /LOVABLE-ACTION -->
```

### RLS Policies
```markdown
<!-- LOVABLE-ACTION: RLS -->
Need RLS policy on `new_table`:
- SELECT: Users can view their own rows (user_id = auth.uid())
- INSERT: Users can insert their own rows
- UPDATE: Users can update their own rows
- DELETE: Users can delete their own rows
<!-- /LOVABLE-ACTION -->
```

### Edge Function Deployment
```markdown
<!-- LOVABLE-ACTION: DEPLOY -->
Please deploy edge function: `analyze-deck-health`
Changes made: Added new analysis metrics for card completeness
<!-- /LOVABLE-ACTION -->
```

### Secrets
```markdown
<!-- LOVABLE-ACTION: SECRET -->
Need new secret: `OPENAI_API_KEY` for GPT-4 integration
<!-- /LOVABLE-ACTION -->
```

### Package Installation
```markdown
<!-- LOVABLE-ACTION: PACKAGE -->
Need to install: `@tanstack/react-table@latest` for data tables
<!-- /LOVABLE-ACTION -->
```

---

## ‚úÖ Pre-Session Checklist

Before starting work:
- [ ] Pull latest from GitHub
- [ ] Review this instruction file
- [ ] Confirm scope is Dashboard & App only
- [ ] Note any LOVABLE-ACTION items from previous sessions

## ‚úÖ Post-Session Checklist

After completing work:
- [ ] List all files modified
- [ ] List all edge functions that need deployment
- [ ] List any database changes needed
- [ ] List any new secrets required
- [ ] List any packages to install
- [ ] Summarize all LOVABLE-ACTION markers

---

## üìã Summary Template for Lovable

After your Claude Code session, copy this to Lovable:

```markdown
## Claude Code Session Summary

### Files Modified
- `src/pages/Dashboard.tsx` - [description]
- `src/components/deck-builder/...` - [description]

### Edge Functions to Deploy
- [ ] `function-name` - [changes made]

### Database Changes Needed
- [ ] [table/column changes]

### RLS Policies Needed
- [ ] [policy descriptions]

### Secrets to Add
- [ ] [secret names]

### Packages to Install
- [ ] [package names]
```

---

## üî¥ Red Flags - STOP and Ask

If you're about to do any of these, STOP:

1. ‚ùå Editing anything in `src/pages/Index.tsx`, `Auth.tsx`, `Onboarding.tsx`, `Quiz.tsx`, `Quiz2.tsx`
2. ‚ùå Editing anything in `src/components/landing/*`, `onboarding/*`, `quiz/*`
3. ‚ùå Creating files in `supabase/migrations/`
4. ‚ùå Editing `.env`, `supabase/config.toml`, or `src/integrations/supabase/*`
5. ‚ùå Adding direct Supabase imports (always use the client from integrations)
6. ‚ùå Removing existing functionality that might affect landing pages
7. ‚ùå Changing routing in `src/App.tsx` for pre-dashboard routes
